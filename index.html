<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMO Pro Exam Engine</title>
    <style>
      :root {
        --primary: #007bff;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --bg: #f4f6f8;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg);
        margin: 0;
        padding-bottom: 80px;
      }

      /* UTILITIES */
      .hidden {
        display: none !important;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      /* START SCREEN */
      .card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        margin: 50px auto;
      }

      h2 {
        text-align: center;
        color: #333;
        margin-top: 0;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
      }

      .btn-start {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-start:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      /* DASHBOARD */
      #dashboard {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        border-bottom: 1px solid #ddd;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .timer-box {
        font-family: monospace;
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        background: #eee;
        padding: 5px 10px;
        border-radius: 5px;
      }

      .status-bar {
        display: flex;
        gap: 8px;
        font-size: 0.8rem;
      }

      .pill {
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        white-space: nowrap;
      }

      .pill.green {
        background: var(--success);
      }

      .pill.orange {
        background: var(--warning);
        color: #333;
      }

      .pill.gray {
        background: #6c757d;
      }

      /* QUESTION GRID */
      .q-container {
        background: white;
        margin-top: 20px;
        border-radius: 10px;
        padding: 10px 20px;
      }

      .grid-header {
        display: flex;
        padding: 10px 0;
        border-bottom: 2px solid #eee;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .head-q {
        width: 50px;
      }

      .head-opt {
        flex: 1;
        text-align: left;
        padding-left: 10px;
      }

      .question-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .q-num {
        font-weight: bold;
        width: 50px;
        color: #555;
        flex-shrink: 0;
      }

      .options {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        align-items: center;
      }

      .options input {
        display: none;
      }

      .bubble {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        user-select: none;
        transition: transform 0.1s;
      }

      input:checked + .bubble {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        transform: scale(1.1);
        transition: transform 0.2s;
      }

      .doubt-wrapper input:checked + .bubble {
        background: var(--warning);
        border-color: var(--warning);
        color: #333;
      }

      .btn-review {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        margin-top: 30px;
        cursor: pointer;
      }

      /* MODAL */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin: 20px 0;
      }

      .stat-box {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
      }

      .stat-val {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
      }

      .stat-label {
        font-size: 0.8rem;
        color: #666;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn-back {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
      }

      .btn-confirm {
        flex: 1;
        padding: 12px;
        background: var(--success);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
      }

      /* --- MOBILE OPTIMIZATION --- */
      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }
        .q-container {
          padding: 10px 5px;
        }
        .bubble {
          width: 30px;
          height: 30px;
          font-size: 14px;
        }
        .options {
          gap: 5px;
        }
        .q-num,
        .head-q {
          width: 35px;
          margin-right: 5px;
          font-size: 14px;
        }
        .pill {
          font-size: 0.7rem;
          padding: 3px 6px;
        }
      }
    </style>
  </head>

  <body>
    <div id="start-view">
      <div class="card">
        <h2>üöÄ IMO Exam Setup</h2>

        <div class="input-group">
          <label>Roll Number</label>
          <input type="text" id="inp-roll" placeholder="Enter Roll No" />
        </div>

        <div class="input-group">
          <label>Password</label>
          <input type="password" id="inp-pass" placeholder="Enter password" />
        </div>

        <div class="input-group">
          <label>Student Name</label>
          <input type="text" id="inp-name" placeholder="Enter Full Name" />
        </div>

        <div class="input-group">
          <label>Select Year</label>
          <select id="inp-year"></select>
        </div>

        <div class="input-group">
          <label>Paper Set</label>
          <select id="inp-set">
            <option value="Set A">Set A</option>
            <option value="Set B">Set B</option>
            <option value="Set C">Set C</option>
            <option value="Set D">Set D</option>
          </select>
        </div>

        <p
          id="resume-msg"
          class="hidden"
          style="color: green; text-align: center; font-size: 0.9em"
        >
          <b>Found saved progress!</b>
        </p>
        <button class="btn-start" onclick="startExam()">Start Test</button>
      </div>
    </div>

    <div id="exam-view" class="hidden">
      <div id="dashboard">
        <div class="timer-box" id="timer-display">00:00</div>
        <div class="status-bar">
          <div class="pill green" id="count-attempted">0 Done</div>
          <div class="pill orange" id="count-doubt">0 Doubt</div>
          <div class="pill gray" id="count-left">50 Left</div>
        </div>
      </div>

      <div class="container">
        <div style="text-align: center; margin-bottom: 20px">
          <h2 style="margin: 0; color: #333">IMO Practice Exam</h2>
          <div
            id="exam-header-details"
            style="
              display: inline-block;
              background: #e3f2fd;
              color: #0d47a1;
              padding: 5px 15px;
              border-radius: 20px;
              font-weight: bold;
              font-size: 0.9rem;
              margin-top: 5px;
            "
          ></div>
        </div>
        <form id="omr-form">
          <input type="hidden" name="StudentName" id="sub-name" />
          <input type="hidden" name="RollNumber" id="sub-roll" />
          <input type="hidden" name="Password" id="sub-pass" />
          <input type="hidden" name="Year" id="sub-year" />
          <input type="hidden" name="SetNumber" id="sub-set" />
          <input type="hidden" name="TotalTime" id="sub-time" />

          <div class="q-container">
            <div class="grid-header">
              <div class="head-q">Q.No</div>
              <div class="head-opt">Options</div>
            </div>
            <div id="questions-container"></div>
          </div>

          <button type="button" class="btn-review" onclick="showReviewModal()">
            Review & Submit
          </button>
        </form>
      </div>
    </div>

    <div id="review-modal" class="hidden modal-overlay">
      <div class="modal-content">
        <h3>üìù Exam Summary</h3>
        <div class="stat-grid">
          <div class="stat-box">
            <span
              class="stat-val"
              style="color: var(--success)"
              id="modal-done"
            >
              0
            </span>
            <span class="stat-label">Attempted</span>
          </div>
          <div class="stat-box">
            <span
              class="stat-val"
              style="color: var(--warning)"
              id="modal-doubt"
            >
              0
            </span>
            <span class="stat-label">Doubt</span>
          </div>
          <div class="stat-box">
            <span class="stat-val" style="color: var(--danger)" id="modal-left">
              50
            </span>
            <span class="stat-label">Left</span>
          </div>
        </div>
        <p style="color: #666; font-size: 0.9em">
          Are you sure you want to submit?
        </p>
        <div class="modal-actions">
          <button class="btn-back" onclick="closeReviewModal()">
            Keep Checking
          </button>
          <button
            class="btn-confirm"
            id="final-submit-btn"
            onclick="submitFinal()"
          >
            Yes, Submit
          </button>
        </div>
      </div>
    </div>

    <script>
      const TOTAL_QUESTIONS = 50;
      // Array of multiple choice options
      const OPTIONS = ["A", "B", "C", "D"];

      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxsqE1PEztf65CjCB8uQCo67-43fwNezaNvRp0CAaeyfvGVA7cAUQr6f0XZ4eoIe_TALw/exec";

      // Variable to store the timer interval ID for clearing later
      let timerInterval;
      // Tracks total elapsed time in seconds during the exam
      let totalSeconds = 0;

      // Runs when the HTML page fully loads
      window.onload = function () {
        // Populate the year dropdown with available academic years
        populateYears();
        // Check if there's any saved progress in browser storage
        checkLocalStorage();
      };

      // 1. POPULATE DROPDOWNS (Year Selection)
      // Generates a list of academic years based on the current date
      // Academic year runs from June to May
      function populateYears() {
        const select = document.getElementById("inp-year");
        const today = new Date();
        const month = today.getMonth(); // 0 = Jan, 6 = July, 11 = Dec
        const year = today.getFullYear();

        // Calculate the current academic year
        // If month is July (6) or later, the ongoing year started in current year
        // Otherwise, it started in the previous year
        let ongoingYearStart = month >= 6 ? year : year - 1;
        let startYear = ongoingYearStart - 1;

        // Clear any existing options
        select.innerHTML = "";

        // Generate 5 academic year options going backwards in time
        for (let i = 0; i < 5; i++) {
          const y1 = startYear - i;
          // Extract last 2 digits of the ending year (e.g., 2024 becomes "24")
          const y2 = (y1 + 1).toString().slice(-2);
          // Format as "2023-24", "2022-23", etc.
          const val = `${y1}-${y2}`;

          // Create a new option element and add it to the dropdown
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        }
      }

      // 2. RESTORE SAVED DATA (Auto-fill from previous session)
      // Checks if the student has previously started an exam and pre-fills their information
      function checkLocalStorage() {
        // Retrieve saved student name from browser local storage
        const savedName = localStorage.getItem("imo_name");
        if (savedName) {
          // Pre-fill the name field
          document.getElementById("inp-name").value = savedName;
          
          // Get the year dropdown and saved academic year
          const yearSelect = document.getElementById("inp-year");
          const savedYear = localStorage.getItem("imo_year");
          
          // Check if the saved year exists in the dropdown before setting it
          if ([...yearSelect.options].some((o) => o.value === savedYear)) {
            yearSelect.value = savedYear;
          }
          
          // Pre-fill the paper set (A, B, C, or D)
          document.getElementById("inp-set").value =
            localStorage.getItem("imo_set");
          
          // Display a message indicating saved progress was found
          document.getElementById("resume-msg").classList.remove("hidden");
        }
      }

      // Saves the current exam progress to browser storage
      // This allows students to resume if they accidentally close the browser
      function saveProgress() {
        // Get all form data (student answers)
        const form = document.getElementById("omr-form");
        const formData = new FormData(form);
        
        // Convert form data to a regular JavaScript object
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }
        
        // Save answers and elapsed time to local storage
        localStorage.setItem("imo_answers", JSON.stringify(data));
        localStorage.setItem("imo_time", totalSeconds);
      }

      // --- 3. LOGIN & EXAM START ---
      // Main function to validate student credentials and start the exam
      function startExam() {
        // Collect student information from input fields
        const name = document.getElementById("inp-name").value;
        const roll = document.getElementById("inp-roll").value;
        const pass = document.getElementById("inp-pass").value;
        const year = document.getElementById("inp-year").value;
        const set = document.getElementById("inp-set").value;
        const btn = document.querySelector(".btn-start");

        // Validate that all required fields are filled
        if (!name || !roll || !pass) {
          alert("Please enter Name, Roll Number, and Password.");
          return;
        }

        // Show loading state on the button
        btn.innerText = "Verifying...";
        btn.disabled = true;

        // Prepare data to send to the backend for validation
        const formData = new FormData();
        formData.append("action", "validate");
        formData.append("RollNumber", roll);
        formData.append("Password", pass);
        formData.append("Year", year);
        formData.append("SetNumber", set);

        // Send validation request to Google Apps Script backend
        fetch(SCRIPT_URL, { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            // If validation is successful, proceed to the exam
            if (data.result === "success") {
              proceedToExam(name, roll, pass);
            } else {
              // Show error message from backend (e.g., wrong password)
              alert(data.message);
              btn.innerText = "Start Test";
              btn.disabled = false;
            }
          })
          .catch((error) => {
            // Handle network errors
            alert("‚ùå Network Error.");
            btn.innerText = "Start Test";
            btn.disabled = false;
          });
      }

      // Proceed to exam after successful authentication
      // Hides the login screen and shows the exam grid
      function proceedToExam(name, roll, pass) {
        // Populate hidden form fields with student information
        document.getElementById("sub-name").value = name;
        document.getElementById("sub-roll").value = roll;
        document.getElementById("sub-pass").value = pass;

        // Get and store the exam year and paper set
        const currentYear = document.getElementById("inp-year").value;
        const currentSet = document.getElementById("inp-set").value;

        document.getElementById("sub-year").value = currentYear;
        document.getElementById("sub-set").value = currentSet;

        // Display exam details in the header
        document.getElementById(
          "exam-header-details"
        ).innerText = `${currentYear}    ${currentSet}`;

        // Save exam details to browser storage for potential resumption
        localStorage.setItem("imo_name", name);
        localStorage.setItem("imo_year", currentYear);
        localStorage.setItem("imo_set", currentSet);

        // Hide the login screen and show the exam screen
        document.getElementById("start-view").classList.add("hidden");
        document.getElementById("exam-view").classList.remove("hidden");

        // Generate the question grid (50 questions with A, B, C, D, ? options)
        renderGrid();

        // Restore previously saved answers if they exist
        const savedAnswers = JSON.parse(localStorage.getItem("imo_answers"));
        if (savedAnswers) {
          for (const [key, value] of Object.entries(savedAnswers)) {
            const field = document.querySelector(
              `input[name="${key}"][value="${value}"]`
            );
            if (field) field.checked = true;
          }
        }
        
        // Restore previously saved elapsed time if it exists
        const savedTime = localStorage.getItem("imo_time");
        if (savedTime) totalSeconds = parseInt(savedTime);

        // Start the timer and update statistics
        startTimer();
        updateStats();
      }

      // --- 4. EXAM UI ---
      // Starts the countdown timer that displays elapsed time
      // Updates the timer display every second and saves progress every 5 seconds
      function startTimer() {
        timerInterval = setInterval(() => {
          // Increment total seconds
          totalSeconds++;
          
          // Convert seconds to MM:SS format
          const m = Math.floor(totalSeconds / 60)
            .toString()
            .padStart(2, "0"); // Pad with zero to ensure 2 digits
          const s = (totalSeconds % 60).toString().padStart(2, "0");
          
          // Display the formatted time on the dashboard
          document.getElementById("timer-display").innerText = `${m}:${s}`;
          
          // Update the hidden time field with current time
          document.getElementById("sub-time").value = `${m}:${s}`;
          
          // Auto-save progress every 5 seconds to prevent data loss
          if (totalSeconds % 5 === 0) saveProgress();
        }, 1000); // Run every 1000 milliseconds (1 second)
      }

      // Generates the OMR (Optical Mark Recognition) grid with all questions
      // Creates 50 question rows with A, B, C, D options and a doubt (?) button
      function renderGrid() {
        const container = document.getElementById("questions-container");
        // Clear any existing questions
        container.innerHTML = "";
        
        // Create 50 question rows
        for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
          const row = document.createElement("div");
          row.className = "question-row";

          let html = `<div class="q-num">${i}.</div><div class="options">`;

          // Add the four standard multiple choice options (A, B, C, D)
          OPTIONS.forEach((opt) => {
            html += `<div><input type="radio" name="Q${i}" id="q${i}_${opt}" value="${opt}" onchange="handleInput()"><label class="bubble" for="q${i}_${opt}">${opt}</label></div>`;
          });

          // Add the "doubt" option (?) for questions the student is unsure about
          html += `<div class="doubt-wrapper">
         <input type="radio" name="Q${i}" id="q${i}_DOUBT" value="DOUBT" onchange="handleInput()">
         <label class="bubble" for="q${i}_DOUBT">?</label>
      </div>`;

          html += `</div>`;
          row.innerHTML = html;
          container.appendChild(row);
        }
      }

      // Called whenever the student changes an answer
      // Updates the statistics and saves progress automatically
      function handleInput() {
        // Recalculate and display updated statistics (done, doubt, left)
        updateStats();
        // Auto-save the current answers to browser storage
        saveProgress();
      }

      // Updates the dashboard statistics showing number of answers completed, doubts, and remaining
      function updateStats() {
        // Get all form data (student answers)
        const form = document.getElementById("omr-form");
        const formData = new FormData(form);
        let attempted = 0;
        let doubt = 0;

        // Count attempted answers and doubt marks
        for (let pair of formData.entries()) {
          // Only process fields that start with "Q" (question fields)
          if (pair[0].startsWith("Q")) {
            if (pair[1] === "DOUBT") {
              // If the answer is "DOUBT", increment doubt counter
              doubt++;
            } else {
              // Otherwise, it's a regular attempt with A, B, C, or D
              attempted++;
            }
          }
        }

        // Calculate remaining unanswered questions
        const left = TOTAL_QUESTIONS - (attempted + doubt);

        // Update the dashboard display with current statistics
        document.getElementById(
          "count-attempted"
        ).innerText = `${attempted} Done`;
        document.getElementById("count-doubt").innerText = `${doubt} Doubt`;
        document.getElementById("count-left").innerText = `${left} Left`;

        // Also update the review modal statistics
        document.getElementById("modal-done").innerText = attempted;
        document.getElementById("modal-doubt").innerText = doubt;
        document.getElementById("modal-left").innerText = left;
      }

      // Shows the review/summary modal before final submission
      function showReviewModal() {
        document.getElementById("review-modal").classList.remove("hidden");
      }
      
      // Hides the review modal when the student wants to continue answering
      function closeReviewModal() {
        document.getElementById("review-modal").classList.add("hidden");
      }

      // --- 5. FINAL SUBMISSION ---
      // Submits the completed exam to the backend for evaluation
      function submitFinal() {
        // Get the submit button and change it to show loading state
        const btn = document.getElementById("final-submit-btn");
        btn.textContent = "Analyzing...";
        btn.disabled = true;
        
        // Stop the timer so no more time is added after submission
        clearInterval(timerInterval);

        // Prepare the form data for submission
        const form = document.getElementById("omr-form");
        const formData = new FormData(form);
        
        // Add action and password to the submission
        formData.append("action", "submit");
        formData.append("Password", document.getElementById("sub-pass").value);

        // Send the exam to the backend for evaluation
        fetch(SCRIPT_URL, { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            // If submission was successful, process the results
            if (data.result === "success") {
              // Hide exam and modal screens
              document.getElementById("exam-view").classList.add("hidden");
              document.getElementById("review-modal").classList.add("hidden");
              
              // Display the performance report
              showResultScreen(data);
              
              // Clear all saved data since exam is complete
              localStorage.clear();
            } else {
              // Show error message from backend
              alert(data.message);
              btn.disabled = false;
              btn.textContent = "Yes, Submit";
              // Resume the timer if submission failed
              startTimer();
            }
          })
          .catch((error) => {
            // Handle network errors during submission
            alert("‚ùå Error! Check internet.");
            btn.textContent = "Yes, Submit";
            btn.disabled = false;
          });
      }

      // --- 6. PERFORMANCE REPORT SCREEN ---
      // Displays the final exam results and detailed analysis after submission
      function showResultScreen(data) {
        // Clear the entire page body
        const body = document.body;
        body.innerHTML = "";

        // Calculate total time spent on the exam
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        const timeString = `${m}m ${s}s`;

        // Create a table of mistakes showing incorrect answers
        // Maps each mistake to a table row with question number, section, student's answer, and correct answer
        let tableRows = data.mistakes
          .map(
            (m) => `
      <tr style="border-bottom:1px solid #eee;">
        <td style="padding:10px; font-weight:bold;">${m.q}</td>
        <td style="padding:10px; font-size:0.9em; color:#666;">${m.section}</td>
        <td style="padding:10px; color:#dc3545; font-weight:bold;">${
          m.student === "DOUBT" ? "?" : m.student
        }</td>
        <td style="padding:10px; color:#28a745; font-weight:bold;">${
          m.correct
        }</td>
      </tr>
    `
          )
          .join("");

        // Create the results container
        const resultDiv = document.createElement("div");
        resultDiv.className = "container";

        // Build the HTML for the complete performance report
        resultDiv.innerHTML = `
      <div class="card" style="text-align:center; max-width:800px;">
         <h1 style="color:#007bff">üìä Performance Report</h1>
         
         <!-- Score Statistics Grid -->
         <div class="stat-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:20px;">
           <!-- Score Section -->
           <div class="stat-box" style="border-left: 5px solid #28a745;">
             <span class="stat-label">Score</span>
             <span class="stat-val" style="color:#28a745; font-size:1.8rem;">${
               data.percentage
             }%</span>
             <span class="stat-label" style="font-size:0.7em;">${
               data.score
             } / ${data.maxScore}</span>
           </div>
           
           <!-- Accuracy Section -->
           <div class="stat-box" style="border-left: 5px solid #007bff;">
             <span class="stat-label">Accuracy</span>
             <span class="stat-val" style="color:#007bff; font-size:1.4rem;">${
               data.accuracy || "0%"
             }</span>
             <span class="stat-label" style="font-size:0.7em;">Quality of Attempt</span>
           </div>

           <!-- Weakest Area Section -->
           <div class="stat-box" style="border-left: 5px solid #dc3545;">
             <span class="stat-label">Weakest Area</span>
             <span class="stat-val" style="color:#dc3545; font-size:1.1rem; line-height:1.2; padding-top:5px;">${
               data.weakestSection
             }</span>
           </div>
         </div>

         <!-- Section Performance Breakdown -->
         <div style="background:#f8f9fa; padding:15px; border-radius:8px; text-align:left; margin-bottom:20px;">
            <h4 style="margin:0 0 10px 0; color:#555;">üß© Section Breakdown</h4>
            <pre style="margin:0; font-family:inherit; white-space: pre-wrap; color:#333;">${
              data.sectionReport || "No Data"
            }</pre>
         </div>

         <!-- Strategy and Recommendations -->
         <div style="background:#fff3cd; padding:10px; border-radius:8px; font-size:0.9em; margin-bottom:20px; border:1px solid #ffeeba;">
            <strong>Strategy:</strong> ${data.strategy || ""}
         </div>

         <!-- Detailed Error Analysis Table -->
         <h3 style="text-align:left; margin-top:30px; border-bottom:2px solid #eee; padding-bottom:10px;">
            ‚ö†Ô∏è Detailed Error Log
         </h3>
         
         <div style="overflow-x:auto;">
           <table style="width:100%; border-collapse:collapse; text-align:left;">
             <!-- Table Headers -->
             <thead>
               <tr style="background:#f8f9fa;">
                 <th style="padding:10px;">Q.No</th>
                 <th style="padding:10px;">Section</th>
                 <th style="padding:10px;">Student</th>
                 <th style="padding:10px;">Key</th>
               </tr>
             </thead>
             <!-- Table Body with Mistake Rows -->
             <tbody>
               ${
                 tableRows.length > 0
                   ? tableRows
                   : '<tr><td colspan="4" style="text-align:center; padding:20px;">üéâ Clean Sheet! Great Job!</td></tr>'
               }
             </tbody>
           </table>
         </div>

         <!-- Close Report Button -->
         <button class="btn-review" onclick="location.reload()" style="margin-top:30px;">Close Report</button>
      </div>
    `;
        // Add the report to the page
        body.appendChild(resultDiv);
      }
    </script>
  </body>
</html>
