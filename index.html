<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMO Pro Exam Engine</title>
    <style>
      :root {
        --primary: #007bff;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --bg: #f4f6f8;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg);
        margin: 0;
        padding-bottom: 80px;
      }

      /* UTILITIES */
      .hidden {
        display: none !important;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      /* START SCREEN */
      .card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        margin: 50px auto;
      }

      h2 {
        text-align: center;
        color: #333;
        margin-top: 0;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
      }

      .btn-start {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-start:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      /* DASHBOARD */
      #dashboard {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        border-bottom: 1px solid #ddd;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .timer-box {
        font-family: monospace;
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        background: #eee;
        padding: 5px 10px;
        border-radius: 5px;
      }

      .status-bar {
        display: flex;
        gap: 8px;
        font-size: 0.8rem;
      }

      .pill {
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        white-space: nowrap;
      }

      .pill.green {
        background: var(--success);
      }

      .pill.orange {
        background: var(--warning);
        color: #333;
      }

      .pill.gray {
        background: #6c757d;
      }

      /* QUESTION GRID */
      .q-container {
        background: white;
        margin-top: 20px;
        border-radius: 10px;
        padding: 10px 20px;
      }

      .grid-header {
        display: flex;
        padding: 10px 0;
        border-bottom: 2px solid #eee;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .head-q {
        width: 50px;
      }

      .head-opt {
        flex: 1;
        text-align: left;
        padding-left: 10px;
      }

      .question-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .q-num {
        font-weight: bold;
        width: 50px;
        color: #555;
        flex-shrink: 0;
      }

      .options {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        align-items: center;
      }

      .options input {
        display: none;
      }

      .bubble {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        user-select: none;
        transition: transform 0.1s;
      }

      input:checked + .bubble {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        transform: scale(1.1);
        transition: transform 0.2s;
      }

      .doubt-wrapper input:checked + .bubble {
        background: var(--warning);
        border-color: var(--warning);
        color: #333;
      }

      .btn-review {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        margin-top: 30px;
        cursor: pointer;
      }

      /* MODAL */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin: 20px 0;
      }

      .stat-box {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
      }

      .stat-val {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
      }

      .stat-label {
        font-size: 0.8rem;
        color: #666;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn-back {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
      }

      .btn-confirm {
        flex: 1;
        padding: 12px;
        background: var(--success);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
      }

      /* --- MOBILE OPTIMIZATION --- */
      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }
        .q-container {
          padding: 10px 5px;
        }
        .bubble {
          width: 30px;
          height: 30px;
          font-size: 14px;
        }
        .options {
          gap: 5px;
        }
        .q-num,
        .head-q {
          width: 35px;
          margin-right: 5px;
          font-size: 14px;
        }
        .pill {
          font-size: 0.7rem;
          padding: 3px 6px;
        }
      }
    </style>
  </head>

  <body>
    <div id="start-view">
      <div class="card">
        <h2>üöÄ IMO Exam Setup</h2>

        <div class="input-group">
          <label>Roll Number</label>
          <input type="text" id="inp-roll" placeholder="Enter Roll No" />
        </div>

        <div class="input-group">
          <label>Password</label>
          <input type="password" id="inp-pass" placeholder="Enter password" />
        </div>

        <div class="input-group">
          <label>Student Name</label>
          <input type="text" id="inp-name" placeholder="Enter Full Name" />
        </div>

        <div class="input-group">
          <label>Select Year</label>
          <select id="inp-year"></select>
        </div>

        <div class="input-group">
          <label>Paper Set</label>
          <select id="inp-set">
            <option value="Set A">Set A</option>
            <option value="Set B">Set B</option>
          </select>
        </div>

        <p
          id="resume-msg"
          class="hidden"
          style="color: green; text-align: center; font-size: 0.9em"
        >
          Found saved progress!
        </p>
        <button class="btn-start" onclick="startExam()">Start Test</button>
      </div>
    </div>

    <div id="exam-view" class="hidden">
      <div id="dashboard">
        <div class="timer-box" id="timer-display">00:00</div>
        <div class="status-bar">
          <div class="pill green" id="count-attempted">0 Done</div>
          <div class="pill orange" id="count-doubt">0 Doubt</div>
          <div class="pill gray" id="count-left">50 Left</div>
        </div>
      </div>

      <div class="container">
        <form id="omr-form">
          <input type="hidden" name="StudentName" id="sub-name" />
          <input type="hidden" name="RollNumber" id="sub-roll" />
          <input type="hidden" name="Password" id="sub-pass" />
          <input type="hidden" name="Year" id="sub-year" />
          <input type="hidden" name="SetNumber" id="sub-set" />
          <input type="hidden" name="TotalTime" id="sub-time" />

          <div class="q-container">
            <div class="grid-header">
              <div class="head-q">Q.No</div>
              <div class="head-opt">Options</div>
            </div>
            <div id="questions-container"></div>
          </div>

          <button type="button" class="btn-review" onclick="showReviewModal()">
            Review & Submit
          </button>
        </form>
      </div>
    </div>

    <div id="review-modal" class="hidden modal-overlay">
      <div class="modal-content">
        <h3>üìù Exam Summary</h3>
        <div class="stat-grid">
          <div class="stat-box">
            <span
              class="stat-val"
              style="color: var(--success)"
              id="modal-done"
            >
              0
            </span>
            <span class="stat-label">Attempted</span>
          </div>
          <div class="stat-box">
            <span
              class="stat-val"
              style="color: var(--warning)"
              id="modal-doubt"
            >
              0
            </span>
            <span class="stat-label">Doubt</span>
          </div>
          <div class="stat-box">
            <span class="stat-val" style="color: var(--danger)" id="modal-left">
              50
            </span>
            <span class="stat-label">Left</span>
          </div>
        </div>
        <p style="color: #666; font-size: 0.9em">
          Are you sure you want to submit?
        </p>
        <div class="modal-actions">
          <button class="btn-back" onclick="closeReviewModal()">
            Keep Checking
          </button>
          <button
            class="btn-confirm"
            id="final-submit-btn"
            onclick="submitFinal()"
          >
            Yes, Submit
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- CONFIG ---
      const TOTAL_QUESTIONS = 50;
      const OPTIONS = ["A", "B", "C", "D"];
      // REPLACE WITH YOUR URL
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxsqE1PEztf65CjCB8uQCo67-43fwNezaNvRp0CAaeyfvGVA7cAUQr6f0XZ4eoIe_TALw/exec";
        // "https://script.google.com/macros/s/AKfycbxEKGmjwUziJYZVwwv_-PwaPzG_vPJFcLDyVQ-rBvMr/dev"

      let timerInterval;
      let totalSeconds = 0;

      window.onload = function () {
        populateYears();
        checkLocalStorage();
      };

      // 1. POPULATE DROPDOWNS (YOUR LOGIC KEPT AS IS)
      function populateYears() {
        const select = document.getElementById("inp-year");
        const today = new Date();
        const month = today.getMonth(); // 0 = Jan, 6 = July, 11 = Dec
        const year = today.getFullYear();

        // 1. Calculate the 'Ongoing' Academic Year Start
        // If it's July-Dec 2025, the ongoing year is 2025.
        let ongoingYearStart = month >= 6 ? year : year - 1;
        let startYear = ongoingYearStart - 1;

        select.innerHTML = "";

        // 3. Generate 5 options backwards
        for (let i = 0; i < 5; i++) {
          const y1 = startYear - i;
          const y2 = (y1 + 1).toString().slice(-2); // Get last 2 digits
          const val = `${y1}-${y2}`;

          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        }
      }

      // 2. RESTORE DATA
      function checkLocalStorage() {
        const savedName = localStorage.getItem("imo_name");
        if (savedName) {
          document.getElementById("inp-name").value = savedName;
          const yearSelect = document.getElementById("inp-year");
          const savedYear = localStorage.getItem("imo_year");
          if ([...yearSelect.options].some((o) => o.value === savedYear)) {
            yearSelect.value = savedYear;
          }
          document.getElementById("inp-set").value =
            localStorage.getItem("imo_set");
          document.getElementById("resume-msg").classList.remove("hidden");
        }
      }

      function saveProgress() {
        const form = document.getElementById("omr-form");
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }
        localStorage.setItem("imo_answers", JSON.stringify(data));
        localStorage.setItem("imo_time", totalSeconds);
      }

      // --- 3. LOGIN & START ---
      function startExam() {
        const name = document.getElementById("inp-name").value;
        const roll = document.getElementById("inp-roll").value;
        const pass = document.getElementById("inp-pass").value;
        // Capture Year/Set for validation
        const year = document.getElementById("inp-year").value;
        const set = document.getElementById("inp-set").value;
        const btn = document.querySelector(".btn-start");

        if (!name || !roll || !pass) {
          alert("Please enter Name, Roll Number, and Password.");
          return;
        }

        btn.innerText = "Verifying...";
        btn.disabled = true;

        const formData = new FormData();
        formData.append("action", "validate");
        formData.append("RollNumber", roll);
        formData.append("Password", pass);
        // Send these so backend can check daily limit NOW
        formData.append("Year", year);
        formData.append("SetNumber", set);

        fetch(SCRIPT_URL, { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            if (data.result === "success") {
              proceedToExam(name, roll, pass);
            } else {
              alert(data.message);
              btn.innerText = "Start Test";
              btn.disabled = false;
            }
          })
          .catch((error) => {
            alert("‚ùå Network Error.");
            btn.innerText = "Start Test";
            btn.disabled = false;
          });
      }

      function proceedToExam(name, roll, pass) {
        document.getElementById("sub-name").value = name;
        document.getElementById("sub-roll").value = roll;
        document.getElementById("sub-pass").value = pass;
        document.getElementById("sub-year").value =
          document.getElementById("inp-year").value;
        document.getElementById("sub-set").value =
          document.getElementById("inp-set").value;

        localStorage.setItem("imo_name", name);
        localStorage.setItem(
          "imo_year",
          document.getElementById("inp-year").value
        );
        localStorage.setItem(
          "imo_set",
          document.getElementById("inp-set").value
        );

        document.getElementById("start-view").classList.add("hidden");
        document.getElementById("exam-view").classList.remove("hidden");

        renderGrid();

        const savedAnswers = JSON.parse(localStorage.getItem("imo_answers"));
        if (savedAnswers) {
          for (const [key, value] of Object.entries(savedAnswers)) {
            const field = document.querySelector(
              `input[name="${key}"][value="${value}"]`
            );
            if (field) field.checked = true;
          }
        }
        const savedTime = localStorage.getItem("imo_time");
        if (savedTime) totalSeconds = parseInt(savedTime);

        startTimer();
        updateStats();
      }

      // --- 4. EXAM UI ---
      function startTimer() {
        timerInterval = setInterval(() => {
          totalSeconds++;
          const m = Math.floor(totalSeconds / 60)
            .toString()
            .padStart(2, "0");
          const s = (totalSeconds % 60).toString().padStart(2, "0");
          document.getElementById("timer-display").innerText = `${m}:${s}`;
          document.getElementById("sub-time").value = `${m}:${s}`;
          if (totalSeconds % 5 === 0) saveProgress();
        }, 1000);
      }

      // --- UPDATED: Renders A,B,C,D AND the '?' Button ---
      function renderGrid() {
        const container = document.getElementById("questions-container");
        container.innerHTML = "";
        for (let i = 1; i <= TOTAL_QUESTIONS; i++) {
          const row = document.createElement("div");
          row.className = "question-row";

          let html = `<div class="q-num">${i}.</div><div class="options">`;

          // Standard Options
          OPTIONS.forEach((opt) => {
            html += `<div><input type="radio" name="Q${i}" id="q${i}_${opt}" value="${opt}" onchange="handleInput()"><label class="bubble" for="q${i}_${opt}">${opt}</label></div>`;
          });

          // --- ADDED: Doubt Option ---
          html += `<div class="doubt-wrapper">
         <input type="radio" name="Q${i}" id="q${i}_DOUBT" value="DOUBT" onchange="handleInput()">
         <label class="bubble" for="q${i}_DOUBT">?</label>
      </div>`;

          html += `</div>`;
          row.innerHTML = html;
          container.appendChild(row);
        }
      }

      function handleInput() {
        updateStats();
        saveProgress();
      }

      // --- UPDATED: Counts 'Doubt' separately ---
      function updateStats() {
        const form = document.getElementById("omr-form");
        const formData = new FormData(form);
        let attempted = 0;
        let doubt = 0;

        for (let pair of formData.entries()) {
          if (pair[0].startsWith("Q")) {
            if (pair[1] === "DOUBT") {
              doubt++;
            } else {
              attempted++;
            }
          }
        }

        const left = TOTAL_QUESTIONS - (attempted + doubt);

        // Update Top Bar
        document.getElementById(
          "count-attempted"
        ).innerText = `${attempted} Done`;
        document.getElementById("count-doubt").innerText = `${doubt} Doubt`; // Now updates!
        document.getElementById("count-left").innerText = `${left} Left`;

        // Update Modal
        document.getElementById("modal-done").innerText = attempted;
        document.getElementById("modal-doubt").innerText = doubt;
        document.getElementById("modal-left").innerText = left;
      }

      function showReviewModal() {
        document.getElementById("review-modal").classList.remove("hidden");
      }
      function closeReviewModal() {
        document.getElementById("review-modal").classList.add("hidden");
      }

      // --- 5. SUBMIT ---
      function submitFinal() {
        const btn = document.getElementById("final-submit-btn");
        btn.textContent = "Analyzing...";
        btn.disabled = true;
        clearInterval(timerInterval);

        const form = document.getElementById("omr-form");
        const formData = new FormData(form);
        formData.append("action", "submit");
        formData.append("Password", document.getElementById("sub-pass").value);

        fetch(SCRIPT_URL, { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            if (data.result === "success") {
              document.getElementById("exam-view").classList.add("hidden");
              document.getElementById("review-modal").classList.add("hidden");
              showResultScreen(data);
              localStorage.clear();
            } else {
              alert(data.message);
              btn.disabled = false;
              btn.textContent = "Yes, Submit";
              startTimer();
            }
          })
          .catch((error) => {
            alert("‚ùå Error! Check internet.");
            btn.textContent = "Yes, Submit";
            btn.disabled = false;
          });
      }

      // --- 6. REPORT SCREEN ---
      function showResultScreen(data) {
        const body = document.body;
        body.innerHTML = "";

        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        const timeString = `${m}m ${s}s`;

        let tableRows = data.mistakes
          .map(
            (m) => `
      <tr style="border-bottom:1px solid #eee;">
        <td style="padding:10px; font-weight:bold;">${m.q}</td>
        <td style="padding:10px; font-size:0.9em; color:#666;">${m.section}</td>
        <td style="padding:10px; color:#dc3545; font-weight:bold;">${
          m.student === "DOUBT" ? "?" : m.student
        }</td>
        <td style="padding:10px; color:#28a745; font-weight:bold;">${
          m.correct
        }</td>
      </tr>
    `
          )
          .join("");

        const resultDiv = document.createElement("div");
        resultDiv.className = "container";

        resultDiv.innerHTML = `
      <div class="card" style="text-align:center; max-width:800px;">
         <h1 style="color:#007bff">üìä Coach Insight Report</h1>
         
         <div class="stat-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom:20px;">
           <div class="stat-box" style="border-left: 5px solid #28a745;">
             <span class="stat-label">Performance</span>
             <span class="stat-val" style="color:#28a745; font-size:1.8rem;">${
               data.percentage
             }%</span>
             <span class="stat-label" style="font-size:0.7em;">${
               data.score
             } / ${data.maxScore}</span>
           </div>
           <div class="stat-box" style="border-left: 5px solid #dc3545;">
             <span class="stat-label">Weakest Area</span>
             <span class="stat-val" style="color:#dc3545; font-size:1.1rem; line-height:1.2; padding-top:5px;">${
               data.weakestSection
             }</span>
             <span class="stat-label" style="font-size:0.7em;">Needs Focus</span>
           </div>
           <div class="stat-box" style="border-left: 5px solid #007bff;">
             <span class="stat-label">Time Taken</span>
             <span class="stat-val" style="color:#007bff; font-size:1.4rem;">${timeString}</span>
             <span class="stat-label" style="font-size:0.7em;">Efficiency</span>
           </div>
         </div>

         <h3 style="text-align:left; margin-top:30px; border-bottom:2px solid #eee; padding-bottom:10px;">
            ‚ö†Ô∏è Detailed Error Log
         </h3>
         
         <div style="overflow-x:auto;">
           <table style="width:100%; border-collapse:collapse; text-align:left;">
             <thead>
               <tr style="background:#f8f9fa;">
                 <th style="padding:10px;">Q.No</th>
                 <th style="padding:10px;">Section</th>
                 <th style="padding:10px;">Student</th>
                 <th style="padding:10px;">Key</th>
               </tr>
             </thead>
             <tbody>
               ${
                 tableRows.length > 0
                   ? tableRows
                   : '<tr><td colspan="4" style="padding:20px; text-align:center; color:green;">üéâ No Mistakes! Perfect Score!</td></tr>'
               }
             </tbody>
           </table>
         </div>

         <button class="btn-review" onclick="location.reload()" style="margin-top:30px;">Close Report</button>
      </div>
    `;
        body.appendChild(resultDiv);
      }
    </script>
  </body>
</html>
